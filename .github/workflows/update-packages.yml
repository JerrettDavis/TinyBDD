name: Update Packages

on:
  schedule:
    - cron: '0 0 * * 0' # Weekly on Sunday at midnight UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-packages:
    name: Update NuGet Packages
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            8.0.x
            9.0.x
            10.0.x

      - name: Install dotnet-outdated
        run: dotnet tool install --global dotnet-outdated-tool

      - name: Check for outdated packages
        id: check
        run: |
          echo "Checking for outdated packages..."
          dotnet outdated --upgrade --version-lock Major > outdated.txt 2>&1 || true

          if [ -s outdated.txt ]; then
            echo "has-updates=true" >> $GITHUB_OUTPUT
            echo "Outdated packages found:"
            cat outdated.txt
          else
            echo "has-updates=false" >> $GITHUB_OUTPUT
            echo "All packages are up to date!"
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has-updates == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'deps: update NuGet packages to latest versions'
          title: 'deps: Update NuGet packages to latest versions'
          body: |
            ## ðŸ“¦ NuGet Package Updates

            This PR updates NuGet packages to their latest versions while preserving major version compatibility.

            ### Changes
            ```
            $(cat outdated.txt)
            ```

            ### Checklist
            - [ ] All tests pass
            - [ ] No breaking changes introduced
            - [ ] Documentation updated (if needed)

            ---
            *This PR was automatically generated by the Update Packages workflow.*
          branch: deps/update-packages
          delete-branch: true
          labels: |
            dependencies
            nuget
            automated
