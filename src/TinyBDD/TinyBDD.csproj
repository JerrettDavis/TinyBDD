<Project Sdk="Microsoft.NET.Sdk" InitialTargets="GenerateOverloads">

    <PropertyGroup>
        <GenerateDocumentationFile>true</GenerateDocumentationFile>
        <PublishRepositoryUrl>true</PublishRepositoryUrl>
        <IncludeSymbols>true</IncludeSymbols>
        <SymbolPackageFormat>snupkg</SymbolPackageFormat>

        <!-- stamp for incremental build -->
        <OverloadsStamp>$(BaseIntermediateOutputPath)overloads.stamp</OverloadsStamp>
    </PropertyGroup>

    <!-- Run codegen once during outer build or for single-target projects, skip design-time -->
    <Target Name="GenerateOverloads"
            BeforeTargets="PrepareForBuild"
            Inputs="build\GenerateOverloads.csx"
            Outputs="$(OverloadsStamp);Generated\Bdd.Given.g.cs"
            Condition="'$(DesignTimeBuild)' != 'true' AND ('$(IsCrossTargetingBuild)' == 'true' OR '$(TargetFrameworks)' == '')">
        <Message Text="[GenerateOverloads] Running code generation" Importance="High"/>
        <MakeDir Directories="Generated;$(BaseIntermediateOutputPath)"/>
        
        <!-- Use dotnet-script for generation -->
        <Exec Command="dotnet-script build\GenerateOverloads.csx --no-cache"
              WorkingDirectory="$(MSBuildProjectDirectory)"/>
        
        <Touch Files="$(OverloadsStamp)" AlwaysCreate="true"/>
    </Target>

    <!-- Keep generated files out of the default glob; include only if present -->
    <ItemGroup>
        <Compile Remove="Generated\**\*.g.cs"/>
        <Compile Remove="build\**\*.*"/>
    </ItemGroup>

    <Target Name="_IncludeGenerated" BeforeTargets="CoreCompile">
        <ItemGroup Condition="Exists('Generated')">
            <Compile Include="Generated\**\*.g.cs"/>
        </ItemGroup>
    </Target>

    <ItemGroup>
        <PackageReference Include="Microsoft.SourceLink.GitHub" PrivateAssets="All"/>
        <PackageReference Include="System.Threading.Tasks.Extensions" />
    </ItemGroup>

    <ItemGroup Condition="'$(TargetFramework)' == 'netstandard2.0' OR '$(TargetFramework)' == 'netstandard2.1' OR '$(TargetFramework)' == 'net462' OR '$(TargetFramework)' == 'net47' OR '$(TargetFramework)' == 'net471' OR '$(TargetFramework)' == 'net472' OR '$(TargetFramework)' == 'net48' OR '$(TargetFramework)' == 'net481'">
        <PackageReference Include="PolySharp">
            <PrivateAssets>all</PrivateAssets>
            <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
        </PackageReference>
    </ItemGroup>

    <ItemGroup Condition="'$(TargetFramework)' == 'net8.0' OR '$(TargetFramework)' == 'net9.0'">
        <Compile Remove="Parser.Platform.NetLegacy.cs"/>
    </ItemGroup>

    <ItemGroup Condition="'$(TargetFramework)' == 'netstandard2.1'">
        <Compile Remove="Parser.Platform.NetModern.cs"/>
    </ItemGroup>

    <ItemGroup>
      <Folder Include="Generated\" />
    </ItemGroup>

</Project>
